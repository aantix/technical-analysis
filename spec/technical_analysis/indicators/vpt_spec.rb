require 'technical-analysis'
require 'spec_helper'

describe 'Indicators' do
  describe "VPT" do
    input_data = SpecHelper.get_test_data(:close, :volume)

    describe 'Volume-Price Trend' do
      it 'Calculates VPT' do
        output = TechnicalAnalysis::Vpt.calculate(input_data)

        expected_output = [
          {:date=>"2018/10/10", :value=>-1903264.3174505206},
          {:date=>"2018/10/11", :value=>-2370279.621573285},
          {:date=>"2018/10/12", :value=>-959554.7990039173},
          {:date=>"2018/10/15", :value=>-1607126.441433344},
          {:date=>"2018/10/16", :value=>-972399.6540759658},
          {:date=>"2018/10/17", :value=>-1070464.7668376141},
          {:date=>"2018/10/18", :value=>-1827517.8777377433},
          {:date=>"2018/10/19", :value=>-1326839.4882367724},
          {:date=>"2018/10/22", :value=>-1151165.4943468445},
          {:date=>"2018/10/23", :value=>-786529.9466468699},
          {:date=>"2018/10/24", :value=>-2158324.481734193},
          {:date=>"2018/10/25", :value=>-1522689.2992524402},
          {:date=>"2018/10/26", :value=>-2274149.490335243},
          {:date=>"2018/10/29", :value=>-3132205.8074873467},
          {:date=>"2018/10/30", :value=>-2949972.4593908517},
          {:date=>"2018/10/31", :value=>-1959004.510023763},
          {:date=>"2018/11/01", :value=>-1146038.8004377298},
          {:date=>"2018/11/02", :value=>-7185217.517024899},
          {:date=>"2018/11/05", :value=>-9060892.67270255},
          {:date=>"2018/11/06", :value=>-8717279.945880784},
          {:date=>"2018/11/07", :value=>-7707600.723227796},
          {:date=>"2018/11/08", :value=>-7883463.234301859},
          {:date=>"2018/11/09", :value=>-8545161.134440955},
          {:date=>"2018/11/12", :value=>-11113790.317206156},
          {:date=>"2018/11/13", :value=>-11580638.32359231},
          {:date=>"2018/11/14", :value=>-13290943.979317216},
          {:date=>"2018/11/15", :value=>-12149014.896876106},
          {:date=>"2018/11/16", :value=>-11748170.533467716},
          {:date=>"2018/11/19", :value=>-13397928.75906581},
          {:date=>"2018/11/20", :value=>-16631473.78435367},
          {:date=>"2018/11/21", :value=>-16666614.749434467},
          {:date=>"2018/11/23", :value=>-17266635.256844807},
          {:date=>"2018/11/26", :value=>-16662634.99217477},
          {:date=>"2018/11/27", :value=>-16752197.088154612},
          {:date=>"2018/11/28", :value=>-14985612.348714761},
          {:date=>"2018/11/29", :value=>-15304600.832189944},
          {:date=>"2018/11/30", :value=>-15517586.252407152},
          {:date=>"2018/12/03", :value=>-14101104.854714246},
          {:date=>"2018/12/04", :value=>-15910856.843135413},
          {:date=>"2018/12/06", :value=>-16386993.991247926},
          {:date=>"2018/12/07", :value=>-17873132.82137613},
          {:date=>"2018/12/10", :value=>-17466268.97188952},
          {:date=>"2018/12/11", :value=>-17729175.804436687},
          {:date=>"2018/12/12", :value=>-17630301.940948576},
          {:date=>"2018/12/13", :value=>-17282902.245502096},
          {:date=>"2018/12/14", :value=>-18582658.71932485},
          {:date=>"2018/12/17", :value=>-18985158.397835847},
          {:date=>"2018/12/18", :value=>-18546614.21276814},
          {:date=>"2018/12/19", :value=>-20031264.8456338},
          {:date=>"2018/12/20", :value=>-21656330.504158247},
          {:date=>"2018/12/21", :value=>-25370780.481841102},
          {:date=>"2018/12/24", :value=>-26332500.093066465},
          {:date=>"2018/12/26", :value=>-22238622.758734256},
          {:date=>"2018/12/27", :value=>-22573553.26073845},
          {:date=>"2018/12/28", :value=>-22552168.387219403},
          {:date=>"2018/12/31", :value=>-22218723.601326805},
          {:date=>"2019/01/02", :value=>-22178057.48873647},
          {:date=>"2019/01/03", :value=>-31252972.592586517},
          {:date=>"2019/01/04", :value=>-28801593.76496151},
          {:date=>"2019/01/07", :value=>-28923059.940598898},
          {:date=>"2019/01/08", :value=>-28148662.548589166},
          {:date=>"2019/01/09", :value=>-27383899.78109331}
        ]

        expect(output).to eq(expected_output)
      end

      it "Throws exception if not enough data" do
        expect {TechnicalAnalysis::Vpt.calculate([])}.to raise_exception(Validation::ValidationError)
      end
    end
  end
end
