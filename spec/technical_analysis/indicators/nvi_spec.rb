require 'technical-analysis'
require 'spec_helper'

describe 'Indicators' do
  describe "NVI" do
    input_data = SpecHelper.get_test_data(:close, :volume)

    describe 'Negative Volume Index' do
      it 'Calculates NVI' do
        output = TechnicalAnalysis::Nvi.calculate(input_data)

        expected_output = [
          {:date=>"2018/10/09", :value=>1000.0},
          {:date=>"2018/10/10", :value=>1000.0},
          {:date=>"2018/10/11", :value=>1000.0},
          {:date=>"2018/10/12", :value=>1003.5719281883889},
          {:date=>"2018/10/15", :value=>1001.4333482054976},
          {:date=>"2018/10/16", :value=>1003.6370655407939},
          {:date=>"2018/10/17", :value=>1003.2049250951491},
          {:date=>"2018/10/18", :value=>1003.2049250951491},
          {:date=>"2018/10/19", :value=>1003.2049250951491},
          {:date=>"2018/10/22", :value=>1003.8159323451605},
          {:date=>"2018/10/23", :value=>1003.8159323451605},
          {:date=>"2018/10/24", :value=>1003.8159323451605},
          {:date=>"2018/10/25", :value=>1006.0057133670583},
          {:date=>"2018/10/26", :value=>1006.0057133670583},
          {:date=>"2018/10/29", :value=>1004.1286907133366},
          {:date=>"2018/10/30", :value=>1004.6281253156736},
          {:date=>"2018/10/31", :value=>1004.6281253156736},
          {:date=>"2018/11/01", :value=>1004.6281253156736},
          {:date=>"2018/11/02", :value=>1004.6281253156736},
          {:date=>"2018/11/05", :value=>1001.7892974768458},
          {:date=>"2018/11/06", :value=>1002.8707003242093},
          {:date=>"2018/11/07", :value=>1002.8707003242093},
          {:date=>"2018/11/08", :value=>1002.1752966566695},
          {:date=>"2018/11/09", :value=>1002.1752966566695},
          {:date=>"2018/11/12", :value=>1002.1752966566695},
          {:date=>"2018/11/13", :value=>1001.1761721781198},
          {:date=>"2018/11/14", :value=>1001.1761721781198},
          {:date=>"2018/11/15", :value=>1003.6440522637729},
          {:date=>"2018/11/16", :value=>1004.7516224011742},
          {:date=>"2018/11/19", :value=>1004.7516224011742},
          {:date=>"2018/11/20", :value=>1004.7516224011742},
          {:date=>"2018/11/21", :value=>1004.6386152817257},
          {:date=>"2018/11/23", :value=>1002.0987352047939},
          {:date=>"2018/11/26", :value=>1002.0987352047939},
          {:date=>"2018/11/27", :value=>1001.8811198113682},
          {:date=>"2018/11/28", :value=>1001.8811198113682},
          {:date=>"2018/11/29", :value=>1001.1129093548633},
          {:date=>"2018/11/30", :value=>1000.5726698672554},
          {:date=>"2018/12/03", :value=>1000.5726698672554},
          {:date=>"2018/12/04", :value=>1000.5726698672554},
          {:date=>"2018/12/06", :value=>1000.5726698672554},
          {:date=>"2018/12/07", :value=>997.0069647390503},
          {:date=>"2018/12/10", :value=>997.0069647390503},
          {:date=>"2018/12/11", :value=>996.4350307767862},
          {:date=>"2018/12/12", :value=>996.713747493859},
          {:date=>"2018/12/13", :value=>997.8077746966976},
          {:date=>"2018/12/14", :value=>997.8077746966976},
          {:date=>"2018/12/17", :value=>997.8077746966976},
          {:date=>"2018/12/18", :value=>999.1070305219995},
          {:date=>"2018/12/19", :value=>999.1070305219995},
          {:date=>"2018/12/20", :value=>999.1070305219995},
          {:date=>"2018/12/21", :value=>999.1070305219995},
          {:date=>"2018/12/24", :value=>996.519622574013},
          {:date=>"2018/12/26", :value=>996.519622574013},
          {:date=>"2018/12/27", :value=>995.8706437612625},
          {:date=>"2018/12/28", :value=>995.9218765502475},
          {:date=>"2018/12/31", :value=>996.888400265283},
          {:date=>"2019/01/02", :value=>996.888400265283},
          {:date=>"2019/01/03", :value=>996.888400265283},
          {:date=>"2019/01/04", :value=>1001.1573361960799},
          {:date=>"2019/01/07", :value=>1000.9347542454526},
          {:date=>"2019/01/08", :value=>1002.8410612825647},
          {:date=>"2019/01/09", :value=>1002.8410612825647}
        ]

        expect(output).to eq(expected_output)
      end

      it "Throws exception if not enough data" do
        expect {TechnicalAnalysis::Nvi.calculate([])}.to raise_exception(Validation::ValidationError)
      end
    end
  end
end
