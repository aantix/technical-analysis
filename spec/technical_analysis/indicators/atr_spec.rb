require 'technical-analysis'
require 'spec_helper'

describe 'Indicators' do
  describe "ATR" do
    input_data = SpecHelper.get_test_data(:high, :low, :close)

    describe 'Average True Range' do
      it 'Calculates ATR (14 day)' do
        output = TechnicalAnalysis::Atr.calculate(input_data, period: 14)

        expected_output = [
          {:date=>"2018/10/29", :value=>7.449807142857144},
          {:date=>"2018/10/30", :value=>7.339820918367347},
          {:date=>"2018/10/31", :value=>7.326262281341107},
          {:date=>"2018/11/01", :value=>7.199386404102457},
          {:date=>"2018/11/02", :value=>7.884430232380852},
          {:date=>"2018/11/05", :value=>7.98625664435365},
          {:date=>"2018/11/06", :value=>7.63938116975696},
          {:date=>"2018/11/07", :value=>7.542996800488605},
          {:date=>"2018/11/08", :value=>7.244925600453705},
          {:date=>"2018/11/09", :value=>7.173145200421298},
          {:date=>"2018/11/12", :value=>7.423634828962634},
          {:date=>"2018/11/13", :value=>7.302653769751019},
          {:date=>"2018/11/14", :value=>7.391749929054517},
          {:date=>"2018/11/15", :value=>7.233053505550622},
          {:date=>"2018/11/16", :value=>7.109942540868436},
          {:date=>"2018/11/19", :value=>7.212089502234975},
          {:date=>"2018/11/20", :value=>7.43622596636105},
          {:date=>"2018/11/21", :value=>7.1707812544781175},
          {:date=>"2018/11/23", :value=>6.9928683077296805},
          {:date=>"2018/11/26", :value=>6.828377714320418},
          {:date=>"2018/11/27", :value=>6.618493591868961},
          {:date=>"2018/11/28", :value=>6.649315478164034},
          {:date=>"2018/11/29", :value=>6.538650086866604},
          {:date=>"2018/11/30", :value=>6.307317937804704},
          {:date=>"2018/12/03", :value=>6.311080942247224},
          {:date=>"2018/12/04", :value=>6.471003732086706},
          {:date=>"2018/12/06", :value=>6.456646322651943},
          {:date=>"2018/12/07", :value=>6.4540287281768025},
          {:date=>"2018/12/10", :value=>6.475883819021315},
          {:date=>"2018/12/11", :value=>6.355463546234078},
          {:date=>"2018/12/12", :value=>6.1365018643602145},
          {:date=>"2018/12/13", :value=>5.946037445477343},
          {:date=>"2018/12/14", :value=>5.926320485086102},
          {:date=>"2018/12/17", :value=>5.904440450437095},
          {:date=>"2018/12/18", :value=>5.739123275405874},
          {:date=>"2018/12/19", :value=>5.926328755734025},
          {:date=>"2018/12/20", :value=>5.989448130324453},
          {:date=>"2018/12/21", :value=>6.170916121015564},
          {:date=>"2018/12/24", :value=>6.084422112371596},
          {:date=>"2018/12/26", :value=>6.400534818630767},
          {:date=>"2018/12/27", :value=>6.450496617299998},
          {:date=>"2018/12/28", :value=>6.273318287492855},
          {:date=>"2018/12/31", :value=>6.048795552671939},
          {:date=>"2019/01/02", :value=>5.946738727481086},
          {:date=>"2019/01/03", :value=>6.6591145326610075},
          {:date=>"2019/01/04", :value=>6.637742066042365},
          {:date=>"2019/01/07", :value=>6.3729033470393395},
          {:date=>"2019/01/08", :value=>6.195553107965099},
          {:date=>"2019/01/09", :value=>6.103013600253306}
        ]

        expect(output).to eq(expected_output)
      end

      it "Throws exception if not enough data" do
        expect {TechnicalAnalysis::Atr.calculate(input_data, period: input_data.size+1)}.to raise_exception(Validation::ValidationError)
      end
    end
  end
end
