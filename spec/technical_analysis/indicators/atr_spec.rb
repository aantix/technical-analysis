require 'technical-analysis'
require 'spec_helper'

describe 'Indicators' do
  describe "ATR" do
    input_data = SpecHelper.get_test_data(:high, :low, :close)

    describe 'Average True Range' do
      it 'Calculates ATR (14 day)' do
        output = TechnicalAnalysis::Atr.calculate(input_data, period: 14)

        expected_output = [
          {:date=>"2018/10/26", :value=>6.837221428571431},
          {:date=>"2018/10/29", :value=>7.320277040816329},
          {:date=>"2018/10/30", :value=>7.219542966472305},
          {:date=>"2018/10/31", :value=>7.214575611724283},
          {:date=>"2018/11/01", :value=>7.095677353743978},
          {:date=>"2018/11/02", :value=>7.788128971333693},
          {:date=>"2018/11/05", :value=>7.896834044809858},
          {:date=>"2018/11/06", :value=>7.556345898752011},
          {:date=>"2018/11/07", :value=>7.465892620269725},
          {:date=>"2018/11/08", :value=>7.173328861679031},
          {:date=>"2018/11/09", :value=>7.106662514416244},
          {:date=>"2018/11/12", :value=>7.361900906243656},
          {:date=>"2018/11/13", :value=>7.245329412940538},
          {:date=>"2018/11/14", :value=>7.338520169159069},
          {:date=>"2018/11/15", :value=>7.183625871361992},
          {:date=>"2018/11/16", :value=>7.064045451978992},
          {:date=>"2018/11/19", :value=>7.169470776837635},
          {:date=>"2018/11/20", :value=>7.396651435634949},
          {:date=>"2018/11/21", :value=>7.134033475946738},
          {:date=>"2018/11/23", :value=>6.958745370521972},
          {:date=>"2018/11/26", :value=>6.796692129770402},
          {:date=>"2018/11/27", :value=>6.589071263358231},
          {:date=>"2018/11/28", :value=>6.621994744546927},
          {:date=>"2018/11/29", :value=>6.513280834222148},
          {:date=>"2018/11/30", :value=>6.283760774634852},
          {:date=>"2018/12/03", :value=>6.289206433589505},
          {:date=>"2018/12/04", :value=>6.4506916883331105},
          {:date=>"2018/12/06", :value=>6.4377851391664604},
          {:date=>"2018/12/07", :value=>6.436514772083141},
          {:date=>"2018/12/10", :value=>6.459620859791487},
          {:date=>"2018/12/11", :value=>6.340362226949238},
          {:date=>"2018/12/12", :value=>6.122479210738577},
          {:date=>"2018/12/13", :value=>5.933016409971536},
          {:date=>"2018/12/14", :value=>5.914229523544997},
          {:date=>"2018/12/17", :value=>5.893213129006069},
          {:date=>"2018/12/18", :value=>5.728697905505635},
          {:date=>"2018/12/19", :value=>5.916648055112375},
          {:date=>"2018/12/20", :value=>5.980458908318633},
          {:date=>"2018/12/21", :value=>6.162568986295874},
          {:date=>"2018/12/24", :value=>6.076671201560454},
          {:date=>"2018/12/26", :value=>6.393337544306135},
          {:date=>"2018/12/27", :value=>6.443813433998554},
          {:date=>"2018/12/28", :value=>6.267112474427229},
          {:date=>"2018/12/31", :value=>6.043033011968142},
          {:date=>"2019/01/02", :value=>5.941387796827561},
          {:date=>"2019/01/03", :value=>6.654145811339878},
          {:date=>"2019/01/04", :value=>6.63312825338703},
          {:date=>"2019/01/07", :value=>6.368619092430814},
          {:date=>"2019/01/08", :value=>6.1915748715428975},
          {:date=>"2019/01/09", :value=>6.099319523575548}
        ]

        expect(output).to eq(expected_output)
      end

      it "Throws exception if not enough data" do
        expect {TechnicalAnalysis::Atr.calculate(input_data, period: input_data.size+1)}.to raise_exception(Validation::ValidationError)
      end
    end
  end
end
